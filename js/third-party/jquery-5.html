<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>jQuery 中的回调 | notes | Kisstar</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Kisstar&#39;s personal notes">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.746e514c.css" as="style"><link rel="preload" href="/notebook/assets/js/app.ac5e5414.js" as="script"><link rel="preload" href="/notebook/assets/js/1.888612f1.js" as="script"><link rel="preload" href="/notebook/assets/js/144.b93ea60f.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.df889503.js"><link rel="prefetch" href="/notebook/assets/js/100.a1f9e67e.js"><link rel="prefetch" href="/notebook/assets/js/101.e6da1ab5.js"><link rel="prefetch" href="/notebook/assets/js/102.7b726f0f.js"><link rel="prefetch" href="/notebook/assets/js/103.bb9b0700.js"><link rel="prefetch" href="/notebook/assets/js/104.9d6b4399.js"><link rel="prefetch" href="/notebook/assets/js/105.84c6ec4a.js"><link rel="prefetch" href="/notebook/assets/js/106.596b5e1f.js"><link rel="prefetch" href="/notebook/assets/js/107.64e761c2.js"><link rel="prefetch" href="/notebook/assets/js/108.0b916ce7.js"><link rel="prefetch" href="/notebook/assets/js/109.612825ed.js"><link rel="prefetch" href="/notebook/assets/js/11.8c78126c.js"><link rel="prefetch" href="/notebook/assets/js/110.78eee4cc.js"><link rel="prefetch" href="/notebook/assets/js/111.e76827a9.js"><link rel="prefetch" href="/notebook/assets/js/112.b5d1ec37.js"><link rel="prefetch" href="/notebook/assets/js/113.edf35a56.js"><link rel="prefetch" href="/notebook/assets/js/114.afc0b6a7.js"><link rel="prefetch" href="/notebook/assets/js/115.ea88d97d.js"><link rel="prefetch" href="/notebook/assets/js/116.02e3c780.js"><link rel="prefetch" href="/notebook/assets/js/117.f1f29040.js"><link rel="prefetch" href="/notebook/assets/js/118.c854d0c4.js"><link rel="prefetch" href="/notebook/assets/js/119.5327b4e8.js"><link rel="prefetch" href="/notebook/assets/js/12.30a875d7.js"><link rel="prefetch" href="/notebook/assets/js/120.78226d14.js"><link rel="prefetch" href="/notebook/assets/js/121.a2ccd6ae.js"><link rel="prefetch" href="/notebook/assets/js/122.4dd547c9.js"><link rel="prefetch" href="/notebook/assets/js/123.13265590.js"><link rel="prefetch" href="/notebook/assets/js/124.e89cc038.js"><link rel="prefetch" href="/notebook/assets/js/125.ecec5969.js"><link rel="prefetch" href="/notebook/assets/js/126.cce05857.js"><link rel="prefetch" href="/notebook/assets/js/127.79705f7c.js"><link rel="prefetch" href="/notebook/assets/js/128.1bd49f8a.js"><link rel="prefetch" href="/notebook/assets/js/129.67657818.js"><link rel="prefetch" href="/notebook/assets/js/13.5b9fb2b5.js"><link rel="prefetch" href="/notebook/assets/js/130.3bc6bc6c.js"><link rel="prefetch" href="/notebook/assets/js/131.030863ff.js"><link rel="prefetch" href="/notebook/assets/js/132.db2b6b41.js"><link rel="prefetch" href="/notebook/assets/js/133.b844f172.js"><link rel="prefetch" href="/notebook/assets/js/134.3de9bcd6.js"><link rel="prefetch" href="/notebook/assets/js/135.730d68b3.js"><link rel="prefetch" href="/notebook/assets/js/136.0739b9d8.js"><link rel="prefetch" href="/notebook/assets/js/137.6f280acf.js"><link rel="prefetch" href="/notebook/assets/js/138.46be9db0.js"><link rel="prefetch" href="/notebook/assets/js/139.d94981db.js"><link rel="prefetch" href="/notebook/assets/js/14.e1e5f293.js"><link rel="prefetch" href="/notebook/assets/js/140.aedb5368.js"><link rel="prefetch" href="/notebook/assets/js/141.8a248597.js"><link rel="prefetch" href="/notebook/assets/js/142.28f9ff5f.js"><link rel="prefetch" href="/notebook/assets/js/143.770dba9d.js"><link rel="prefetch" href="/notebook/assets/js/145.ca5b0c1d.js"><link rel="prefetch" href="/notebook/assets/js/146.691bfd7b.js"><link rel="prefetch" href="/notebook/assets/js/147.137d9a4c.js"><link rel="prefetch" href="/notebook/assets/js/148.3066feb1.js"><link rel="prefetch" href="/notebook/assets/js/149.e9829597.js"><link rel="prefetch" href="/notebook/assets/js/15.78626d04.js"><link rel="prefetch" href="/notebook/assets/js/150.dd8f3d71.js"><link rel="prefetch" href="/notebook/assets/js/151.e3187091.js"><link rel="prefetch" href="/notebook/assets/js/152.29998b55.js"><link rel="prefetch" href="/notebook/assets/js/153.8a40c28d.js"><link rel="prefetch" href="/notebook/assets/js/154.d2138f1a.js"><link rel="prefetch" href="/notebook/assets/js/155.f3da2753.js"><link rel="prefetch" href="/notebook/assets/js/156.8c78c0df.js"><link rel="prefetch" href="/notebook/assets/js/157.c9af9c5b.js"><link rel="prefetch" href="/notebook/assets/js/158.2f39cfcc.js"><link rel="prefetch" href="/notebook/assets/js/159.b666c541.js"><link rel="prefetch" href="/notebook/assets/js/16.5a03dae8.js"><link rel="prefetch" href="/notebook/assets/js/160.8efb986e.js"><link rel="prefetch" href="/notebook/assets/js/161.ff8c70e2.js"><link rel="prefetch" href="/notebook/assets/js/162.f40d9424.js"><link rel="prefetch" href="/notebook/assets/js/163.b3d88bfa.js"><link rel="prefetch" href="/notebook/assets/js/164.1afb3ae9.js"><link rel="prefetch" href="/notebook/assets/js/165.3f778366.js"><link rel="prefetch" href="/notebook/assets/js/166.c47d7417.js"><link rel="prefetch" href="/notebook/assets/js/167.994fb4ac.js"><link rel="prefetch" href="/notebook/assets/js/168.f621706a.js"><link rel="prefetch" href="/notebook/assets/js/169.b37d0272.js"><link rel="prefetch" href="/notebook/assets/js/17.a7cb4e0c.js"><link rel="prefetch" href="/notebook/assets/js/170.b332f253.js"><link rel="prefetch" href="/notebook/assets/js/171.b349437f.js"><link rel="prefetch" href="/notebook/assets/js/172.0d3bf396.js"><link rel="prefetch" href="/notebook/assets/js/173.b7ccb52d.js"><link rel="prefetch" href="/notebook/assets/js/174.e1915a26.js"><link rel="prefetch" href="/notebook/assets/js/175.454b32ed.js"><link rel="prefetch" href="/notebook/assets/js/176.45b6fc37.js"><link rel="prefetch" href="/notebook/assets/js/177.b617195b.js"><link rel="prefetch" href="/notebook/assets/js/178.f4092fb8.js"><link rel="prefetch" href="/notebook/assets/js/179.fab61496.js"><link rel="prefetch" href="/notebook/assets/js/18.a401c9be.js"><link rel="prefetch" href="/notebook/assets/js/180.b82139da.js"><link rel="prefetch" href="/notebook/assets/js/181.2c78060e.js"><link rel="prefetch" href="/notebook/assets/js/182.6ada1478.js"><link rel="prefetch" href="/notebook/assets/js/183.ffa9341e.js"><link rel="prefetch" href="/notebook/assets/js/184.0ef4f2a5.js"><link rel="prefetch" href="/notebook/assets/js/185.55d07d33.js"><link rel="prefetch" href="/notebook/assets/js/186.8339c6ec.js"><link rel="prefetch" href="/notebook/assets/js/187.6aece17e.js"><link rel="prefetch" href="/notebook/assets/js/188.20a8d586.js"><link rel="prefetch" href="/notebook/assets/js/189.cc1b96ae.js"><link rel="prefetch" href="/notebook/assets/js/19.526b020b.js"><link rel="prefetch" href="/notebook/assets/js/190.403647bb.js"><link rel="prefetch" href="/notebook/assets/js/191.54f6461a.js"><link rel="prefetch" href="/notebook/assets/js/192.19cb4705.js"><link rel="prefetch" href="/notebook/assets/js/193.8e3dd285.js"><link rel="prefetch" href="/notebook/assets/js/194.ac933924.js"><link rel="prefetch" href="/notebook/assets/js/195.1b6d53c1.js"><link rel="prefetch" href="/notebook/assets/js/196.bda44a60.js"><link rel="prefetch" href="/notebook/assets/js/197.d4519d3b.js"><link rel="prefetch" href="/notebook/assets/js/198.9cbb8ce1.js"><link rel="prefetch" href="/notebook/assets/js/199.3fbeadaf.js"><link rel="prefetch" href="/notebook/assets/js/20.ff03f4c0.js"><link rel="prefetch" href="/notebook/assets/js/200.e3c6d1ce.js"><link rel="prefetch" href="/notebook/assets/js/201.23f80d4d.js"><link rel="prefetch" href="/notebook/assets/js/202.fc6298b5.js"><link rel="prefetch" href="/notebook/assets/js/203.23a0fa14.js"><link rel="prefetch" href="/notebook/assets/js/204.5092445b.js"><link rel="prefetch" href="/notebook/assets/js/205.ffbf8c53.js"><link rel="prefetch" href="/notebook/assets/js/206.cfda81d7.js"><link rel="prefetch" href="/notebook/assets/js/207.8e1cdf7a.js"><link rel="prefetch" href="/notebook/assets/js/208.2bc41307.js"><link rel="prefetch" href="/notebook/assets/js/209.609bacea.js"><link rel="prefetch" href="/notebook/assets/js/21.aed8236e.js"><link rel="prefetch" href="/notebook/assets/js/210.0bdb9e3d.js"><link rel="prefetch" href="/notebook/assets/js/211.e3ba1e42.js"><link rel="prefetch" href="/notebook/assets/js/212.c8d23536.js"><link rel="prefetch" href="/notebook/assets/js/213.42519384.js"><link rel="prefetch" href="/notebook/assets/js/214.4d6c6726.js"><link rel="prefetch" href="/notebook/assets/js/215.baf4690c.js"><link rel="prefetch" href="/notebook/assets/js/216.52b94ce0.js"><link rel="prefetch" href="/notebook/assets/js/217.e821152d.js"><link rel="prefetch" href="/notebook/assets/js/218.059a08f5.js"><link rel="prefetch" href="/notebook/assets/js/219.068d001d.js"><link rel="prefetch" href="/notebook/assets/js/22.32040914.js"><link rel="prefetch" href="/notebook/assets/js/220.937596a5.js"><link rel="prefetch" href="/notebook/assets/js/221.1ca6f7e8.js"><link rel="prefetch" href="/notebook/assets/js/222.185510de.js"><link rel="prefetch" href="/notebook/assets/js/223.46bd4769.js"><link rel="prefetch" href="/notebook/assets/js/224.562b3705.js"><link rel="prefetch" href="/notebook/assets/js/225.230bb8de.js"><link rel="prefetch" href="/notebook/assets/js/226.5a382f48.js"><link rel="prefetch" href="/notebook/assets/js/227.e4c6d3a8.js"><link rel="prefetch" href="/notebook/assets/js/228.bbecc9fe.js"><link rel="prefetch" href="/notebook/assets/js/229.2d9bcf4c.js"><link rel="prefetch" href="/notebook/assets/js/23.735705ab.js"><link rel="prefetch" href="/notebook/assets/js/230.fd52949d.js"><link rel="prefetch" href="/notebook/assets/js/231.9e5e5124.js"><link rel="prefetch" href="/notebook/assets/js/232.af33c5ff.js"><link rel="prefetch" href="/notebook/assets/js/233.0cd8a524.js"><link rel="prefetch" href="/notebook/assets/js/234.d78e087e.js"><link rel="prefetch" href="/notebook/assets/js/235.774d8bb8.js"><link rel="prefetch" href="/notebook/assets/js/236.5ac4a311.js"><link rel="prefetch" href="/notebook/assets/js/237.287d1de5.js"><link rel="prefetch" href="/notebook/assets/js/238.f002c4af.js"><link rel="prefetch" href="/notebook/assets/js/239.7920e1b9.js"><link rel="prefetch" href="/notebook/assets/js/24.ed5cdb59.js"><link rel="prefetch" href="/notebook/assets/js/240.3f3c5b19.js"><link rel="prefetch" href="/notebook/assets/js/241.dbda4f31.js"><link rel="prefetch" href="/notebook/assets/js/242.8f5ceaa7.js"><link rel="prefetch" href="/notebook/assets/js/243.b24e52be.js"><link rel="prefetch" href="/notebook/assets/js/244.04bbb54e.js"><link rel="prefetch" href="/notebook/assets/js/245.d0ec3252.js"><link rel="prefetch" href="/notebook/assets/js/246.74f35039.js"><link rel="prefetch" href="/notebook/assets/js/247.1dbc80a3.js"><link rel="prefetch" href="/notebook/assets/js/248.e0fd0d31.js"><link rel="prefetch" href="/notebook/assets/js/249.b0dfbcc1.js"><link rel="prefetch" href="/notebook/assets/js/25.3a915afa.js"><link rel="prefetch" href="/notebook/assets/js/250.0b3b996f.js"><link rel="prefetch" href="/notebook/assets/js/251.05db53d7.js"><link rel="prefetch" href="/notebook/assets/js/252.8414e6bb.js"><link rel="prefetch" href="/notebook/assets/js/253.cdf8aefa.js"><link rel="prefetch" href="/notebook/assets/js/254.3534e986.js"><link rel="prefetch" href="/notebook/assets/js/255.88231eee.js"><link rel="prefetch" href="/notebook/assets/js/256.da893150.js"><link rel="prefetch" href="/notebook/assets/js/257.56db0719.js"><link rel="prefetch" href="/notebook/assets/js/258.7d6eb68d.js"><link rel="prefetch" href="/notebook/assets/js/259.37162616.js"><link rel="prefetch" href="/notebook/assets/js/26.159de74f.js"><link rel="prefetch" href="/notebook/assets/js/260.30a81a58.js"><link rel="prefetch" href="/notebook/assets/js/261.a65dbc1d.js"><link rel="prefetch" href="/notebook/assets/js/262.71a77dfb.js"><link rel="prefetch" href="/notebook/assets/js/263.4ebefbf8.js"><link rel="prefetch" href="/notebook/assets/js/264.912a13c9.js"><link rel="prefetch" href="/notebook/assets/js/265.37cc7f48.js"><link rel="prefetch" href="/notebook/assets/js/266.d6ed08c7.js"><link rel="prefetch" href="/notebook/assets/js/267.77638523.js"><link rel="prefetch" href="/notebook/assets/js/268.904e9b38.js"><link rel="prefetch" href="/notebook/assets/js/269.dee1c37c.js"><link rel="prefetch" href="/notebook/assets/js/27.60e0d719.js"><link rel="prefetch" href="/notebook/assets/js/270.efea0f6c.js"><link rel="prefetch" href="/notebook/assets/js/271.d30ad22c.js"><link rel="prefetch" href="/notebook/assets/js/272.f4c58a1a.js"><link rel="prefetch" href="/notebook/assets/js/273.9c6c5a42.js"><link rel="prefetch" href="/notebook/assets/js/274.f22b6a54.js"><link rel="prefetch" href="/notebook/assets/js/275.ebd6a6bc.js"><link rel="prefetch" href="/notebook/assets/js/276.d58ffbdd.js"><link rel="prefetch" href="/notebook/assets/js/277.43c3a9ac.js"><link rel="prefetch" href="/notebook/assets/js/278.edb1d888.js"><link rel="prefetch" href="/notebook/assets/js/279.cc43d385.js"><link rel="prefetch" href="/notebook/assets/js/28.23ece35e.js"><link rel="prefetch" href="/notebook/assets/js/280.f1ee9a59.js"><link rel="prefetch" href="/notebook/assets/js/29.5b5a2f26.js"><link rel="prefetch" href="/notebook/assets/js/3.7d651dbe.js"><link rel="prefetch" href="/notebook/assets/js/30.c0880838.js"><link rel="prefetch" href="/notebook/assets/js/31.19500470.js"><link rel="prefetch" href="/notebook/assets/js/32.97c2e797.js"><link rel="prefetch" href="/notebook/assets/js/33.46fd8b2a.js"><link rel="prefetch" href="/notebook/assets/js/34.5a6f0634.js"><link rel="prefetch" href="/notebook/assets/js/35.9915b1a2.js"><link rel="prefetch" href="/notebook/assets/js/36.93ec766b.js"><link rel="prefetch" href="/notebook/assets/js/37.b84113b1.js"><link rel="prefetch" href="/notebook/assets/js/38.e507303d.js"><link rel="prefetch" href="/notebook/assets/js/39.7aa42143.js"><link rel="prefetch" href="/notebook/assets/js/4.d884c1c6.js"><link rel="prefetch" href="/notebook/assets/js/40.a58ac5f4.js"><link rel="prefetch" href="/notebook/assets/js/41.2fc7316e.js"><link rel="prefetch" href="/notebook/assets/js/42.7b2c10d3.js"><link rel="prefetch" href="/notebook/assets/js/43.94128301.js"><link rel="prefetch" href="/notebook/assets/js/44.a1a20786.js"><link rel="prefetch" href="/notebook/assets/js/45.aad3d936.js"><link rel="prefetch" href="/notebook/assets/js/46.138b7ce6.js"><link rel="prefetch" href="/notebook/assets/js/47.f550d980.js"><link rel="prefetch" href="/notebook/assets/js/48.b589cfb5.js"><link rel="prefetch" href="/notebook/assets/js/49.175edfb0.js"><link rel="prefetch" href="/notebook/assets/js/5.fdf47beb.js"><link rel="prefetch" href="/notebook/assets/js/50.d475e5ae.js"><link rel="prefetch" href="/notebook/assets/js/51.e95ba781.js"><link rel="prefetch" href="/notebook/assets/js/52.bd0ceee2.js"><link rel="prefetch" href="/notebook/assets/js/53.b9234f75.js"><link rel="prefetch" href="/notebook/assets/js/54.cc6299cd.js"><link rel="prefetch" href="/notebook/assets/js/55.3187ca87.js"><link rel="prefetch" href="/notebook/assets/js/56.6fbe2bed.js"><link rel="prefetch" href="/notebook/assets/js/57.66e99d83.js"><link rel="prefetch" href="/notebook/assets/js/58.6518287a.js"><link rel="prefetch" href="/notebook/assets/js/59.08cbbf90.js"><link rel="prefetch" href="/notebook/assets/js/6.72d278e3.js"><link rel="prefetch" href="/notebook/assets/js/60.7c02c24a.js"><link rel="prefetch" href="/notebook/assets/js/61.56678228.js"><link rel="prefetch" href="/notebook/assets/js/62.a3028f7e.js"><link rel="prefetch" href="/notebook/assets/js/63.ec2cc9f4.js"><link rel="prefetch" href="/notebook/assets/js/64.c96ac711.js"><link rel="prefetch" href="/notebook/assets/js/65.1d820b32.js"><link rel="prefetch" href="/notebook/assets/js/66.cf1c9488.js"><link rel="prefetch" href="/notebook/assets/js/67.71657c6b.js"><link rel="prefetch" href="/notebook/assets/js/68.46423d4b.js"><link rel="prefetch" href="/notebook/assets/js/69.8c1bb0e4.js"><link rel="prefetch" href="/notebook/assets/js/7.d6e3a0f1.js"><link rel="prefetch" href="/notebook/assets/js/70.edcda23b.js"><link rel="prefetch" href="/notebook/assets/js/71.98afce5b.js"><link rel="prefetch" href="/notebook/assets/js/72.bc499829.js"><link rel="prefetch" href="/notebook/assets/js/73.ee8c6a49.js"><link rel="prefetch" href="/notebook/assets/js/74.eee167cd.js"><link rel="prefetch" href="/notebook/assets/js/75.d16c3efd.js"><link rel="prefetch" href="/notebook/assets/js/76.ef29f9df.js"><link rel="prefetch" href="/notebook/assets/js/77.eb63197e.js"><link rel="prefetch" href="/notebook/assets/js/78.7f415abd.js"><link rel="prefetch" href="/notebook/assets/js/79.0b3f9574.js"><link rel="prefetch" href="/notebook/assets/js/8.4538d58b.js"><link rel="prefetch" href="/notebook/assets/js/80.fa12c6bc.js"><link rel="prefetch" href="/notebook/assets/js/81.c3de5f15.js"><link rel="prefetch" href="/notebook/assets/js/82.11ff9eb9.js"><link rel="prefetch" href="/notebook/assets/js/83.e193efe3.js"><link rel="prefetch" href="/notebook/assets/js/84.e813e58b.js"><link rel="prefetch" href="/notebook/assets/js/85.341f52a9.js"><link rel="prefetch" href="/notebook/assets/js/86.bfd904e2.js"><link rel="prefetch" href="/notebook/assets/js/87.02565afa.js"><link rel="prefetch" href="/notebook/assets/js/88.4ecd72ce.js"><link rel="prefetch" href="/notebook/assets/js/89.05b2b135.js"><link rel="prefetch" href="/notebook/assets/js/9.87d0a9d1.js"><link rel="prefetch" href="/notebook/assets/js/90.5d4a2d50.js"><link rel="prefetch" href="/notebook/assets/js/91.cada60d2.js"><link rel="prefetch" href="/notebook/assets/js/92.cb35fde4.js"><link rel="prefetch" href="/notebook/assets/js/93.7580ec8b.js"><link rel="prefetch" href="/notebook/assets/js/94.4e64ad81.js"><link rel="prefetch" href="/notebook/assets/js/95.ef04f29c.js"><link rel="prefetch" href="/notebook/assets/js/96.55b154d0.js"><link rel="prefetch" href="/notebook/assets/js/97.3ca3489b.js"><link rel="prefetch" href="/notebook/assets/js/98.752ca815.js"><link rel="prefetch" href="/notebook/assets/js/99.5e78bf50.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.746e514c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/logo.png" alt="notes | Kisstar" class="logo"> <span class="site-name can-hide">notes | Kisstar</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="IT" class="dropdown-title"><span class="title">IT</span> <span class="arrow down"></span></button> <button type="button" aria-label="IT" class="mobile-dropdown-title"><span class="title">IT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          FED
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/notebook/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/notebook/js/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/notebook/ts/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/notebook/ng/" class="nav-link">
  AngularJS
</a></li><li class="dropdown-subitem"><a href="/notebook/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/notebook/react/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/notebook/web/" class="nav-link">
  WEB
</a></li></ul></li><li class="dropdown-item"><h4>
          BED
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-subitem"><a href="/notebook/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-subitem"><a href="/notebook/nodejs/" class="nav-link">
  NodeJS
</a></li><li class="dropdown-subitem"><a href="/notebook/c/" class="nav-link">
  C/C++
</a></li></ul></li><li class="dropdown-item"><h4>
          OTHER
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/wechat/" class="nav-link">
  WeChat
</a></li><li class="dropdown-subitem"><a href="/notebook/video/" class="nav-link">
  视频
</a></li><li class="dropdown-subitem"><a href="/notebook/project/" class="nav-link">
  项目工程
</a></li><li class="dropdown-subitem"><a href="/notebook/interview/" class="nav-link">
  面试
</a></li><li class="dropdown-subitem"><a href="/notebook/install-equipment/" class="nav-link">
  装机指南
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DevTools" class="dropdown-title"><span class="title">DevTools</span> <span class="arrow down"></span></button> <button type="button" aria-label="DevTools" class="mobile-dropdown-title"><span class="title">DevTools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notebook/vscode/" class="nav-link">
  VSCode
</a></li><li class="dropdown-item"><!----> <a href="/notebook/vim/" class="nav-link">
  Vim
</a></li><li class="dropdown-item"><!----> <a href="/notebook/chrome/" class="nav-link">
  Chrome
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Computer" class="dropdown-title"><span class="title">Computer</span> <span class="arrow down"></span></button> <button type="button" aria-label="Computer" class="mobile-dropdown-title"><span class="title">Computer</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/cp/" class="nav-link">
  Computer Basis
</a></li><li class="dropdown-item"><!----> <a href="/notebook/algorithm/" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notebook/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/notebook/mac/" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/notebook/windows/" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/notebook/database/" class="nav-link">
  Database
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Cloud" class="dropdown-title"><span class="title">Cloud</span> <span class="arrow down"></span></button> <button type="button" aria-label="Cloud" class="mobile-dropdown-title"><span class="title">Cloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notebook/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/notebook/dev-ops/" class="nav-link">
  DevOps
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Others" class="dropdown-title"><span class="title">Others</span> <span class="arrow down"></span></button> <button type="button" aria-label="Others" class="mobile-dropdown-title"><span class="title">Others</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/other/popularization-science/" class="nav-link">
  Truth
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/dev/" class="nav-link">
  Development
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/gitbook/" class="nav-link">
  Gitbook
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/collection/" class="nav-link">
  Collection
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About me" class="dropdown-title"><span class="title">About me</span> <span class="arrow down"></span></button> <button type="button" aria-label="About me" class="mobile-dropdown-title"><span class="title">About me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/kisstar/notebook/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="IT" class="dropdown-title"><span class="title">IT</span> <span class="arrow down"></span></button> <button type="button" aria-label="IT" class="mobile-dropdown-title"><span class="title">IT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          FED
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/notebook/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/notebook/js/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/notebook/ts/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/notebook/ng/" class="nav-link">
  AngularJS
</a></li><li class="dropdown-subitem"><a href="/notebook/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/notebook/react/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/notebook/web/" class="nav-link">
  WEB
</a></li></ul></li><li class="dropdown-item"><h4>
          BED
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-subitem"><a href="/notebook/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-subitem"><a href="/notebook/nodejs/" class="nav-link">
  NodeJS
</a></li><li class="dropdown-subitem"><a href="/notebook/c/" class="nav-link">
  C/C++
</a></li></ul></li><li class="dropdown-item"><h4>
          OTHER
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/wechat/" class="nav-link">
  WeChat
</a></li><li class="dropdown-subitem"><a href="/notebook/video/" class="nav-link">
  视频
</a></li><li class="dropdown-subitem"><a href="/notebook/project/" class="nav-link">
  项目工程
</a></li><li class="dropdown-subitem"><a href="/notebook/interview/" class="nav-link">
  面试
</a></li><li class="dropdown-subitem"><a href="/notebook/install-equipment/" class="nav-link">
  装机指南
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DevTools" class="dropdown-title"><span class="title">DevTools</span> <span class="arrow down"></span></button> <button type="button" aria-label="DevTools" class="mobile-dropdown-title"><span class="title">DevTools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notebook/vscode/" class="nav-link">
  VSCode
</a></li><li class="dropdown-item"><!----> <a href="/notebook/vim/" class="nav-link">
  Vim
</a></li><li class="dropdown-item"><!----> <a href="/notebook/chrome/" class="nav-link">
  Chrome
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Computer" class="dropdown-title"><span class="title">Computer</span> <span class="arrow down"></span></button> <button type="button" aria-label="Computer" class="mobile-dropdown-title"><span class="title">Computer</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/cp/" class="nav-link">
  Computer Basis
</a></li><li class="dropdown-item"><!----> <a href="/notebook/algorithm/" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notebook/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/notebook/mac/" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/notebook/windows/" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/notebook/database/" class="nav-link">
  Database
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Cloud" class="dropdown-title"><span class="title">Cloud</span> <span class="arrow down"></span></button> <button type="button" aria-label="Cloud" class="mobile-dropdown-title"><span class="title">Cloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notebook/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/notebook/dev-ops/" class="nav-link">
  DevOps
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Others" class="dropdown-title"><span class="title">Others</span> <span class="arrow down"></span></button> <button type="button" aria-label="Others" class="mobile-dropdown-title"><span class="title">Others</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/other/popularization-science/" class="nav-link">
  Truth
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/dev/" class="nav-link">
  Development
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/gitbook/" class="nav-link">
  Gitbook
</a></li><li class="dropdown-item"><!----> <a href="/notebook/other/collection/" class="nav-link">
  Collection
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About me" class="dropdown-title"><span class="title">About me</span> <span class="arrow down"></span></button> <button type="button" aria-label="About me" class="mobile-dropdown-title"><span class="title">About me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/kisstar/notebook/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第三方</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/js/third-party/require-js-0.html" class="sidebar-link">RequireJS（一）</a></li><li><a href="/notebook/js/third-party/require-js-1.html" class="sidebar-link">RequireJS (二)</a></li><li><a href="/notebook/js/third-party/require-js-2.html" class="sidebar-link">RequireJS (三)</a></li><li><a href="/notebook/js/third-party/require-js-3.html" class="sidebar-link">RequireJS (四)</a></li><li><a href="/notebook/js/third-party/jquery-0.html" class="sidebar-link">jQuery 的整体结构</a></li><li><a href="/notebook/js/third-party/jquery-1.html" class="sidebar-link">jQuery 中的扩展（拷贝）方式</a></li><li><a href="/notebook/js/third-party/jquery-2.html" class="sidebar-link">jQuery() 是怎么工作的</a></li><li><a href="/notebook/js/third-party/jquery-3.html" class="sidebar-link">jQuery 中的工具函数和方法</a></li><li><a href="/notebook/js/third-party/jquery-4.html" class="sidebar-link">jQuery 中的 DOM 操作</a></li><li><a href="/notebook/js/third-party/jquery-5.html" aria-current="page" class="active sidebar-link">jQuery 中的回调</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>读书笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>奇思妙想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码片段</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jquery-中的回调"><a href="#jquery-中的回调" class="header-anchor">#</a> jQuery 中的回调</h1> <p>通过 <code>jQuery.Callbacks()</code> 函数可以得到一个多用途的回调函数列表对象，提供了一种强大的方式来管理一组回调函数。</p> <p><code>jQuery.Callbacks()</code> 函数接受一个可选的参数，结构为一个用空格分隔的字符列表 (比如：jQuery.Callbacks('unique stopOnFalse'))，用来改变回调列表中的行为：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">once</td> <td style="text-align:left;">确保这个回调列表只执行一次</td></tr> <tr><td style="text-align:left;">memory</td> <td style="text-align:left;">缓存上一次 <code>fire</code> 时的参数值，当 <code>add()</code> 添加回调函数时，直接用上一次的参数值立刻调用新加入的回调函数</td></tr> <tr><td style="text-align:left;">unique</td> <td style="text-align:left;">一个回调只会被添加一次，不会重复添加</td></tr> <tr><td style="text-align:left;">stopOnFalse</td> <td style="text-align:left;">某个回调函数返回 <code>false</code> 之后中断后面的回调函数</td></tr></tbody></table> <p>事实上传递的参数也可以是一个对象，可选的属性就是上面列举的四个参数，值为一个布尔值。从源码中可以清晰的看到这点：</p> <div class="language-js extra-class"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span><span class="token function-variable function">Callbacks</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果接收到的是一个字符串，则通过 createOptions() 函数得到我们真正需要的配置</span>
  <span class="token comment">// 否则我们将通过 jQuery.extend() 方法来获取配置，所以这里可以接受一个对象</span>
  options <span class="token operator">=</span> <span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">createOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token operator">:</span> jQuery<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实，当你传递的是一个字符串时，在内部，最后加工得到的也是一个对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> rnothtmlwhite <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\x20\t\r\n\f]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

<span class="token comment">// Convert String-formatted options into Object-formatted ones</span>
<span class="token keyword">function</span> <span class="token function">createOptions</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 对通过字符串的 match() 方法得到的字符串数组进行遍历，然后将每个字符串作为属性、true 作为值写入结果对象中</span>
  jQuery<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>rnothtmlwhite<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> flag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    object<span class="token punctuation">[</span>flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> object
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们自己来创建一个列表来记录后续注册的回调函数，并提供相应的方法来进行添加回调：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle: add(fn)</span>
    <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>为了支持同时添加多个回调我们可以借助 <code>arguments</code> 来实现：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Handle: add(fn1, fn2)</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEatch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么如果用户想使用数组来直接添加一组回调呢，那么就创建一个辅助函数来完成吧，然后添加一层对各个参数类型的判断，如果是数组则进行递归调用：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Handle: add(fn1, [fn2])</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在添加回调的方法是否差不多了，接下来就开始支持触发吧。最简单的就是遍历列表调用回调，同时将 <code>fire()</code> 方法接受的第一个参数传递给每个回调：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>试试下面的例子，已经可以开始工作了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn3</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn1<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn2<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn2<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn3<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>基本的功能实现后再来看看几个配置参数吧，上面我们已经详细介绍了参数的处理方式，这里我们就简单的使用对象形式来进行配置，首先是 <code>unique</code> 选项，它确定了一个回调只会被添加一次，不会重复添加。</p> <p>这个几乎是最简单的选项了。我们只需要在添加之前查看当前列表中是否已经包含了当前回调，只在没有时才添加（和源码一样我们添加一个辅助方法 has 来判断）：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Handle: add(fn1, [fn2])</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// support unique</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">~</span>list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除此之外，再简单的就是 <code>stopOnFalse</code> 选项了，它在某个回调函数返回 <code>false</code> 之后中断后面的回调函数，所以我们来修改一下 <code>fire()</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

      <span class="token comment">// support stopOnFalse</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>好的，接着是 <code>once</code> 选项，其实这个也很简单，只需要在调用一次 <code>fire()</code> 方法后就组织再次调用即可，为此我们可以设置一个标志：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> fired<span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// support once</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      fired <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>最后，是一个让人稍微有点疑惑的 <code>memory</code> 选项。使用之后会缓存上一次 <code>fire()</code> 时的参数值，当 <code>add()</code> 添加回调函数时，直接用上一次的参数值立刻调用新加入的回调函数。</p> <p>因此，首先我们在 <code>fire()</code> 执行时记住传递的参数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> executeData<span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      fired <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 记住传递的参数</span>
      executeData <span class="token operator">=</span> value

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>接着 <code>add()</code> 方法中添加完之后自动触发回调执行：</p> <div class="language-js extra-class"><pre class="language-js"><code>self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>executeData<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看起来好像可以了，但事实上使用起来会非常的乱。为了实现我们想要的效果其实还需要记录一下我们上次执行到哪个回调了，这样下次触发时只需从上次结束的地方继续。</p> <p>所以首先在 <code>add()</code> 方法中我们设置一下这个值（回调列表的最后一项的索引）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 fire() 函数还没有执行过那么 memory 参数是没有意义的，所以我们在 executeData 有值时在进行处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>memory <span class="token operator">&amp;&amp;</span> executeData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>memory <span class="token operator">&amp;&amp;</span> executeData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>executeData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>然后就是让 <code>fire()</code> 方法在正确的地方开始执行回调（在执行完成后需要重置，以便我们再次调用 fire 方法）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    fired <span class="token operator">=</span> <span class="token boolean">true</span>
    executeData <span class="token operator">=</span> value

    <span class="token comment">// 将 firingIndex 置为开始的索引</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token operator">++</span>firingIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重置 firingIndex，否则回调列表的函数只能触发一次</span>
    firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在似乎好多了，但在 <code>fire()</code> 函数中对 <code>stopOnFalse</code> 选项的支持出现了新的问题，因为它总是在执行一个回调之后才会去判断是否执行后续的回调，这意味着当我们启用 <code>options.memory</code> 选项后，通过 <code>add()</code> 方法添加的函数将总是被执行。</p> <p>一个解决的方法就是在禁止后续回调执行的同时将 <code>options.memory</code> 选项置为 <code>false</code>，这样后续添加时就不会自动触发回调。但为了不改变用户传入的配置，我们需要使用一个变量来配合工作。</p> <p>事实上，这个变量已经存在了（就是 executeData），因为在改变回调执行位置和自动触发回调之前，我们都对 <code>executeData</code> 进行了判断，如果我们将其置为 <code>fasle</code> 的话，那么后续的回调也就不会自动执行了。</p> <p>为了具备更好的语义，我们就将当前的 <code>executeData</code> 变量改名为 <code>memory</code> 吧，而在 <code>add()</code> 函数中对 <code>options.memory</code> 的检查也就可以去掉了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将 executeData 更名为 memory</span>
<span class="token keyword">var</span> memory<span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除 options.memory</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

        <span class="token comment">// 移除 options.memory</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>同时，更换在 <code>fire()</code> 函数中的 <code>executeData</code> 变量，并且在停止执行时修改 <code>memory</code> 的值。</p> <p>不仅如此，我们还需要在循环体外根据用户的配置来修改 <code>memory</code> 的值，否则它将总是支持 <code>options.memory</code> 选项，即使用户并没有传递相应的配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    fired <span class="token operator">=</span> <span class="token boolean">true</span>
    memory <span class="token operator">=</span> value

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token operator">++</span>firingIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Jump to end and forget the data so .add doesn't re-fire</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token comment">// 目前这行代码没什么用，在源码中它被用来跳出内部循环，而我们这里使用的是 break 关键字</span>
        memory <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

    <span class="token comment">// 如果用户没有启用 options.memory 选项，那么我们就应该将 memory 变量置为 false，以免后续自动触发回调</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      memory <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，在 <code>memory</code> 和 <code>once</code> 配合使用时也存在一些问题。</p> <p>对于选项 <code>once</code> 目前确实控制了用户只能触发一次回调，但需要注意的是在配合 <code>memory</code> 时，在第一轮触发后添加的函数仍属于第一轮触发，所以它们仍需要被立即触发。</p> <p>在我们的逻辑中，如果配置了 <code>once</code> 选项，那么一旦 <code>fire()</code> 方法被调用过就不能再执行后续的回调了，所以我们现在需要作出一些调整。</p> <p>既然我们需要多次触发，而用户只能调用一次 <code>fire()</code> 方法，那么我们就对 <code>fire()</code> 方法继续拆分，这里我们将现有的 <code>fire()</code> 方法的逻辑移动到一个名为 <code>fire()</code> 的私有函数中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 提供给用户的方法</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token function">fire</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部真正用于执行回调的函数</span>
<span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fired <span class="token operator">=</span> options<span class="token punctuation">.</span>once
  memory <span class="token operator">=</span> value

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token operator">++</span>firingIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length
      memory <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应的在 <code>add()</code> 方法中我们不再使用现在的 <code>fire()</code> 方法而是 <code>fire()</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 改用 fire() 函数</span>
        <span class="token function">fire</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>改过之后，基本工作算是可以完成了。问题是，我们在支持 <code>options.memory</code> 选项时，有点过于依赖用户的输入了，因为内部的变量 <code>memory</code> 指代的是用户触发时传递的参数，如果用户没有传递呢？</p> <p>这会导致什么问题呢？即使用户将 <code>options.memory</code> 置为 true，他也不会得到想要的效果，因为在 <code>add()</code> 函数中判断 <code>memory</code> 为假时就不会自动触发回调执行了。</p> <p>怎么解决这个问题呢？答案就是我们将 <code>memory</code> 构造成一个对象，里面记录着用户传递的值，这样即使用户触发时传递了假值，<code>options.memory</code> 选项的工作依然可以正常工作。</p> <p>而且，此时我们还可以对现有功能进行扩展，我们不仅可以让用户指定回调执行时得到的参数，同时还可以指定回调执行时的上下文。为了我们提供给用户一个 <code>fireWith()</code> 方法，顾名思义就是用什么上下文和参数进行触发：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Call all callbacks with the given context and arguments</span>
  <span class="token function-variable function">fireWith</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      args <span class="token operator">=</span> args <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment">// 将用户传递的参数包装成一个数组</span>
      args <span class="token operator">=</span> <span class="token punctuation">[</span>context<span class="token punctuation">,</span> args<span class="token punctuation">.</span>slice <span class="token operator">?</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">]</span>
      memory <span class="token operator">=</span> args
      <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应的，在触发回调执行时需要对上下文和参数进行修改：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fired <span class="token operator">=</span> options<span class="token punctuation">.</span>once

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token operator">++</span>firingIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 绑定指定的 this 值，并提供参数</span>
    <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>memory<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length
      memory <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之前的 <code>fire()</code> 方法的话，内部之前调用现在的 <code>fireWith()</code> 方法就可以了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Call all the callbacks with the given arguments</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">fireWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而且，在 <code>add()</code> 方法中对于 <code>options.memory</code> 选项的支持，自动触发时就不必传递参数了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不必传递参数</span>
        <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>离成功又近了一步，不过新的问题又来了。如果我们在某个注册的回调逻辑中增加触发回调的逻辑呢？在触发回调之后会怎么样？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'fn1: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'fn2: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
  self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">'fire inner'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn3</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'fn3: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn1<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn2<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn3<span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">'fire outter'</span><span class="token punctuation">)</span>
</code></pre></div><p>示例中的代码会进入死循环吗？这里本应该会，但目前的逻辑并不会。因为我们每次都会在一轮回调执行结束之后才会去重置 <code>firingIndex</code> 的值，如果在中途再次触发回调的话 ，根据 <code>firingIndex</code> 的值会从上次执行的地方继续向后执行。</p> <p>这样一来 <code>firingIndex</code> 总有大于列表长度的时候，那时就会停止执行回调。听起来是否不错（毕竟避免了无限循环），但是它会让回调执行的很乱，用户很难搞清楚自己添加的回调是以怎样的顺序被执行的。</p> <p>解决方案就是每触发一次回调执行，就检查当前是否在执行回调，如果没有就按部就班的触发回调；否则，内部先将指定的触发参数用队列保存起来，在一轮回调执行结束执行再去查看还有没有剩余的参数需要用来触发，如果有则使用对应的参数再来执行一遍回调。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> firing<span class="token punctuation">,</span> <span class="token comment">// 是否正在执行回调的标志</span>
  queque <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 存储指定的触发参数</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fireWith</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        args <span class="token operator">=</span> args <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        args <span class="token operator">=</span> <span class="token punctuation">[</span>context<span class="token punctuation">,</span> args<span class="token punctuation">.</span>slice <span class="token operator">?</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">]</span>

        <span class="token comment">// 总是先将指定的触发参数保存起来</span>
        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

        <span class="token comment">// 只在非执行状态才直接执行回调，这样如果在执行过程中某个回调中再次触发就仅仅是添加对应的触发参数到队列中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>那么接下来就是修改 <code>fire()</code> 函数在每轮结束后检查参数队列了，很关键的一点就是在每轮执行后我们必须重置 <code>firingIndex</code>，否则它还是会像之前一样进行累加：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fired <span class="token operator">=</span> options<span class="token punctuation">.</span>once

  <span class="token comment">// 在执行回调前将正在执行的标志置为 true</span>
  firing <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment">// 遍历参数队列，这样就可以在每轮结束后判断其中是否还有需要被用来触发回调的参数</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token operator">++</span>firingIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 绑定指定的 this 值，并提供参数</span>
      <span class="token keyword">var</span> ret <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>memory<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> ret <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length
        memory <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重置 firingIndex，如果在每轮之前重置将会导致 add() 方法中对 firingIndex 的修改变得毫无意义</span>
    firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回调执行结束修正正在执行的标志</span>
  firing <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不错，现在上面的例子执行起来清晰多了，它总是会按顺序循环执行添加的三个回调。但对 <code>options.memory</code> 选项的支持又出现问题了。</p> <p>我们在 <code>add()</code> 方法中通过对 <code>memory</code> 进行判断，如果为真就先记录上次执行的位置，然后在添加完成之后就立即调用 <code>fire()</code> 函数进行执行。</p> <p>首先，如果当前正处于执行状态，那么这里记录执行位置和手动触发是完全没有必要的，因为让其自然添加完成之后，就会在当前轮的后面被自动调用。</p> <p>其次，单纯的记录位置后调用 <code>fire()</code> 函数执行是没有任何意义的，因为在触发时检查的是存储执行参数的队列中还有没有值，所以我们不仅要记录执行位置，同时还要将对应的执行参数放到队列中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只在非执行状态才记录位置和保存数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>firing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>unique <span class="token operator">||</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

      <span class="token comment">// 只在非执行状态才自动触发回调执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memory <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>firing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到目前为止，整个回调管理的核心逻辑已经完成了。为了高度还原源代码我们再来看一下我们的 <code>fire()</code> 函数，在其内部使用了两个 <code>for</code> 循环，而源码中使用的是 <code>for</code> 和 <code>while</code> 循环，现在我们来调整一下我们的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fired <span class="token operator">=</span> options<span class="token punctuation">.</span>once

  firing <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>
    <span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* 根据 for 的工作机制，这里重置的逻辑同样会在每轮循环后才执行，和之前的写法是一致的 */</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>firingIndex <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">[</span>firingIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>memory<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token comment">// 之前我们用 break 来跳出内部循环，所以这行代码实际上没什么用，但现在它被用在这里来跳出内部循环</span>
        memory <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  firing <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着就是一些扩展功能了，其中 <code>lock()</code> 方法通过改变 <code>locked</code> 变量的值来禁止用户再触发回调。</p> <p>现阶段我们使用的是 <code>fired</code> 变量要来禁止用户再触发回调的，不过事实上 <code>fired</code> 变量的指责仅仅是记录当前回调队列有没有被执行过，具体的拦截工作需要交给 <code>locked</code> 变量来完成，所以需要做一些调整：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> locked<span class="token punctuation">,</span>
  self <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fireWith</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locked <span class="token comment">/* 替换 fired 为 locked，根据 locked 的值来决定是否继续触发回调 */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        args <span class="token operator">=</span> args <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        args <span class="token operator">=</span> <span class="token punctuation">[</span>context<span class="token punctuation">,</span> args<span class="token punctuation">.</span>slice <span class="token operator">?</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">]</span>

        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果没有被锁住，那么将根据用户传递的参数来决定是否可以进行后续的触发</span>
  locked <span class="token operator">=</span> locked <span class="token operator">||</span> options<span class="token punctuation">.</span>once

  <span class="token comment">// 只要调用过 fire 函数，那么就说明已经触发过，所以将 fired 的值置为 true</span>
  fired <span class="token operator">=</span> firing <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>firingIndex <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">[</span>firingIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>memory<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length
        memory <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  firing <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，我们只需要将 <code>locked</code> 变量变为一个真值就可以阻止再次触发回调了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Disable .fire</span>
  <span class="token function-variable function">lock</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    locked <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不仅如此，它还会把保存着触发参数的队列清空，同时在没有启用 <code>options.memory</code> 选项的情况下禁用 <code>add()</code> 方法（因为此时再添加方法是毫无意义的，锁住后用户没法再进行触发）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">lock</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Disable .fire &amp; Abort any pending executions</span>
    locked <span class="token operator">=</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// Also disable .add unless we have memory (since it would have no effect)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memory <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>firing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list <span class="token operator">=</span> memory <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的实现中，我们只在没有启用 <code>options.memory</code> 选项和非执行状态才进行重置。与此对应的 <code>disable()</code> 方法，无论当前是否启用了 <code>options.memory</code> 选项、此时是什么状态都会直接重置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Disable .fire and .add</span>
  <span class="token comment">// Abort any current/pending executions</span>
  <span class="token comment">// Clear all callbacks and values</span>
  <span class="token function-variable function">disable</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    locked <span class="token operator">=</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    list <span class="token operator">=</span> memory <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后者很好理解，但前者如果当前在执行状态就不禁用 <code>add()</code> 方法了吗？这和我们之前描述的不太一样啊，事实上，该部分逻辑将会在 <code>fire()</code> 函数中执行完回调队列后进行处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  locked <span class="token operator">=</span> locked <span class="token operator">||</span> options<span class="token punctuation">.</span>once
  fired <span class="token operator">=</span> firing <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> firingIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>firingIndex <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>stopOnFalse <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">[</span>firingIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>memory<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firingIndex <span class="token operator">=</span> list<span class="token punctuation">.</span>length
        memory <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  firing <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memory <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clean up if we're done firing for good</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Keep an empty list if we have data for future add calls</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

      <span class="token comment">// Otherwise, this object is spent</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      list <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，值得一提的就是用来移除指定回调的 <code>remove()</code> 方法。如果被移除的回调的位置在 <code>firingIndex</code> 的前面，那么就需要将 <code>firingIndex</code> 减一，因为从移除的位置开始，后续的所有项的都会往前移：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inArray</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> arr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token function">indexOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Remove a callback from the list</span>
  <span class="token function-variable function">remove</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> index
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token function">inArray</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> list<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">// Handle firing indexes</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> firingIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          firingIndex<span class="token operator">--</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其它的工具方法就相当比较简单了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">empty</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">disabled</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>list
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">locked</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>locked
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fired</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>fired
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，完成了。撒花...</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/js/third-party/jquery-4.html" class="prev">
        jQuery 中的 DOM 操作
      </a></span> <span class="next"><a href="/notebook/js/read/ydkjs0.html">
        YDKJS-作用域
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook/assets/js/app.ac5e5414.js" defer></script><script src="/notebook/assets/js/1.888612f1.js" defer></script><script src="/notebook/assets/js/144.b93ea60f.js" defer></script>
  </body>
</html>
